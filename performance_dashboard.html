<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Graph Performance Dashboard</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
            font-weight: 300;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            color: #7f8c8d;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .metric-trend {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .trend-up {
            color: #27ae60;
        }

        .trend-down {
            color: #e74c3c;
        }

        .trend-stable {
            color: #f39c12;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-button.active {
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        #graphVisualization {
            width: 100%;
            height: 500px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
            position: relative;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .connected {
            background: rgba(46, 204, 113, 0.9);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .disconnected {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .slow-queries {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .query-item {
            padding: 15px;
            border-left: 4px solid #e74c3c;
            margin-bottom: 15px;
            background: #fff5f5;
            border-radius: 0 8px 8px 0;
        }

        .query-text {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .query-stats {
            display: flex;
            gap: 20px;
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .metric-card {
                text-align: center;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        ⚡ Disconnected
    </div>

    <div class="dashboard-container">
        <div class="header">
            <h1>🚀 Performance Monitoring Dashboard</h1>
            <p class="subtitle">Real-time SQL Graph Database Performance Analytics</p>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="qpsValue">1,247</div>
                <div class="metric-label">Queries per Second</div>
                <div class="metric-trend trend-up" id="qpsTrend">↗ +12.5% from last hour</div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="latencyValue">23ms</div>
                <div class="metric-label">Average Latency</div>
                <div class="metric-trend trend-down" id="latencyTrend">↘ -8.2% from last hour</div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="errorRateValue">0.12%</div>
                <div class="metric-label">Error Rate</div>
                <div class="metric-trend trend-stable" id="errorTrend">→ Stable</div>
            </div>

            <div class="metric-card">
                <div class="metric-value" id="activeConnections">87</div>
                <div class="metric-label">Active Connections</div>
                <div class="metric-trend trend-up" id="connectionsTrend">↗ +5 connections</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="controls">
            <button class="control-button active" onclick="showRealTime()">Real-time Monitoring</button>
            <button class="control-button" onclick="showBenchmarks()">Performance Benchmarks</button>
            <button class="control-button" onclick="showAnalysis()">Performance Analysis</button>
            <button class="control-button" onclick="refreshData()">🔄 Refresh Data</button>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Query Performance Over Time</div>
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Database Load Distribution</div>
                <canvas id="loadChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Response Time Distribution</div>
                <canvas id="responseTimeChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Connection Pool Status</div>
                <canvas id="connectionChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Graph Visualization -->
        <div class="chart-container full-width">
            <div class="chart-title">🌐 Performance Graph Visualization</div>
            <div id="graphVisualization">
                <div class="loading">
                    Interactive graph visualization will appear here<br>
                    <small>Connect to see real-time performance data mapped to your database schema</small>
                </div>
            </div>
        </div>

        <!-- Slow Queries Section -->
        <div class="slow-queries">
            <div class="chart-title">🐌 Top Slow Queries</div>
            <div id="slowQueriesList">
                <div class="query-item">
                    <div class="query-text">SELECT * FROM users u JOIN projects p ON u.id = p.creator_id WHERE p.status = 'active'</div>
                    <div class="query-stats">
                        <span>Avg Time: 245ms</span>
                        <span>Executions: 1,247</span>
                        <span>Impact: HIGH</span>
                    </div>
                </div>
                <div class="query-item">
                    <div class="query-text">SELECT COUNT(*) FROM tasks t WHERE t.project_id IN (SELECT id FROM projects WHERE budget > 100000)</div>
                    <div class="query-stats">
                        <span>Avg Time: 189ms</span>
                        <span>Executions: 892</span>
                        <span>Impact: MEDIUM</span>
                    </div>
                </div>
                <div class="query-item">
                    <div class="query-text">UPDATE project_stats SET last_updated = NOW() WHERE project_id = ?</div>
                    <div class="query-stats">
                        <span>Avg Time: 156ms</span>
                        <span>Executions: 2,344</span>
                        <span>Impact: MEDIUM</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection for real-time data
        let ws = null;
        let performanceChart, loadChart, responseTimeChart, connectionChart;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectWebSocket();
            startDataGeneration();
        });

        // WebSocket connection
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:8080/ws/performance');
                
                ws.onopen = function() {
                    updateConnectionStatus(true);
                    console.log('WebSocket connected');
                };
                
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateDashboard(data);
                };
                
                ws.onclose = function() {
                    updateConnectionStatus(false);
                    console.log('WebSocket disconnected');
                    // Reconnect after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };
                
                ws.onerror = function(error) {
                    updateConnectionStatus(false);
                    console.error('WebSocket error:', error);
                };
            } catch (error) {
                updateConnectionStatus(false);
                console.error('Failed to connect WebSocket:', error);
            }
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.innerHTML = '⚡ Connected';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = '⚡ Disconnected';
            }
        }

        // Initialize all charts
        function initializeCharts() {
            // Performance over time chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(),
                    datasets: [{
                        label: 'QPS',
                        data: generateRandomData(12, 800, 1500),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Avg Latency (ms)',
                        data: generateRandomData(12, 15, 35),
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Queries per Second' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Latency (ms)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Load distribution pie chart
            const loadCtx = document.getElementById('loadChart').getContext('2d');
            loadChart = new Chart(loadCtx, {
                type: 'doughnut',
                data: {
                    labels: ['SELECT', 'INSERT', 'UPDATE', 'DELETE', 'JOIN'],
                    datasets: [{
                        data: [45, 20, 18, 12, 5],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Response time histogram
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(responseCtx, {
                type: 'bar',
                data: {
                    labels: ['0-10ms', '10-25ms', '25-50ms', '50-100ms', '100-200ms', '200ms+'],
                    datasets: [{
                        label: 'Query Count',
                        data: [245, 567, 334, 123, 67, 23],
                        backgroundColor: [
                            '#2ecc71',
                            '#27ae60',
                            '#f39c12',
                            '#e67e22',
                            '#e74c3c',
                            '#c0392b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Connection pool status
            const connCtx = document.getElementById('connectionChart').getContext('2d');
            connectionChart = new Chart(connCtx, {
                type: 'line',
                data: {
                    labels: generateTimeLabels(24),
                    datasets: [{
                        label: 'Active Connections',
                        data: generateRandomData(24, 60, 95),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Connections' }
                        }
                    }
                }
            });
        }

        // Generate time labels
        function generateTimeLabels(count = 12) {
            const labels = [];
            const now = new Date();
            for (let i = count - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 5 * 60000);
                labels.push(time.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' }));
            }
            return labels;
        }

        // Generate random data for demo
        function generateRandomData(count, min, max) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return data;
        }

        // Update dashboard with real data
        function updateDashboard(data) {
            if (data.type === 'metrics') {
                updateMetrics(data.data);
            } else if (data.type === 'performance') {
                updateCharts(data.data);
            }
        }

        // Update key metrics
        function updateMetrics(metrics) {
            document.getElementById('qpsValue').textContent = metrics.queriesPerSecond || '1,247';
            document.getElementById('latencyValue').textContent = (metrics.averageLatency || 23) + 'ms';
            document.getElementById('errorRateValue').textContent = (metrics.errorRate || 0.12) + '%';
            document.getElementById('activeConnections').textContent = metrics.activeConnections || '87';
        }

        // Simulate real-time data updates
        function startDataGeneration() {
            setInterval(() => {
                // Simulate metrics updates
                const qps = 800 + Math.random() * 700;
                const latency = 15 + Math.random() * 20;
                const errorRate = Math.random() * 0.5;
                const connections = 60 + Math.random() * 35;

                document.getElementById('qpsValue').textContent = Math.floor(qps).toLocaleString();
                document.getElementById('latencyValue').textContent = Math.floor(latency) + 'ms';
                document.getElementById('errorRateValue').textContent = errorRate.toFixed(2) + '%';
                document.getElementById('activeConnections').textContent = Math.floor(connections);

                // Update charts with new data
                updateChartsWithNewData();
            }, 2000);
        }

        // Update charts with new random data
        function updateChartsWithNewData() {
            // Add new data point and remove oldest
            const newTime = new Date().toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            
            performanceChart.data.labels.push(newTime);
            performanceChart.data.labels.shift();
            
            performanceChart.data.datasets[0].data.push(800 + Math.random() * 700);
            performanceChart.data.datasets[0].data.shift();
            
            performanceChart.data.datasets[1].data.push(15 + Math.random() * 20);
            performanceChart.data.datasets[1].data.shift();
            
            performanceChart.update('none');

            // Update connection chart
            connectionChart.data.labels.push(newTime);
            connectionChart.data.labels.shift();
            connectionChart.data.datasets[0].data.push(60 + Math.random() * 35);
            connectionChart.data.datasets[0].data.shift();
            connectionChart.update('none');
        }

        // Control functions
        function showRealTime() {
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Switching to real-time monitoring view');
        }

        function showBenchmarks() {
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Switching to benchmarks view');
        }

        function showAnalysis() {
            document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            console.log('Switching to analysis view');
        }

        function refreshData() {
            console.log('Refreshing data...');
            
            // Add pulse animation to refresh button
            event.target.classList.add('pulse');
            setTimeout(() => {
                event.target.classList.remove('pulse');
            }, 2000);

            // Refresh charts
            updateChartsWithNewData();
        }

        // D3.js Graph visualization placeholder
        function initializeGraphVisualization() {
            const container = d3.select('#graphVisualization');
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', '500px');

            // Add sample nodes and links for demo
            const nodes = [
                { id: 'users', group: 1, performance: 0.8 },
                { id: 'projects', group: 2, performance: 0.6 },
                { id: 'tasks', group: 3, performance: 0.4 }
            ];

            const links = [
                { source: 'users', target: 'projects', value: 10 },
                { source: 'projects', target: 'tasks', value: 5 }
            ];

            // Simple force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(400, 250));

            const link = svg.selectAll('.link')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .style('stroke', '#999')
                .style('stroke-width', 2);

            const node = svg.selectAll('.node')
                .data(nodes)
                .enter().append('circle')
                .attr('class', 'node')
                .attr('r', 20)
                .style('fill', d => d3.interpolateRdYlGn(d.performance));

            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });
        }

        // Initialize graph visualization after page load
        setTimeout(initializeGraphVisualization, 1000);

        console.log('🚀 Performance Dashboard initialized!');
        console.log('📊 Monitoring system ready');
        console.log('⚡ Connect to WebSocket at ws://localhost:8080/ws/performance for real-time data');
    </script>
</body>
</html>
